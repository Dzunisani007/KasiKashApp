{% extends 'admin_base.html' %}
{% block admin_content %}
<h1 style="color:#60efff;">{{ _('Admin Notifications') }}</h1>
<p style="color:#eaf6fb;">{{ _('Here you can send notifications to users.') }}</p>
<!-- Search/filter bar -->
<div class="mb-6 flex items-center gap-4 bg-[#101c2c] rounded-xl shadow-lg p-4">
  <button class="admin-card btn px-6 py-2 text-base font-semibold shadow-md" style="background:linear-gradient(90deg,#00ff87 0%,#60efff 100%);color:#101c2c;min-width:180px;" onclick="openSendNotificationModal()">{{ _('Create Notification') }}</button>
</div>
<table class="table-auto w-full mt-2 text-sm admin-card" style="background:linear-gradient(135deg,#101c2c 60%,#1e3357 100%);color:#eaf6fb;">
  <thead>
    <tr style="color:#60efff;">
      <th>{{ _('ID') }}</th>
      <th>{{ _('User ID') }}</th>
      <th>{{ _('Stokvel') }}</th>
      <th>{{ _('Urgent') }}</th>
      <th>{{ _('Message') }}</th>
      <th>{{ _('Type') }}</th>
      <th>{{ _('Created At') }}</th>
      <th>{{ _('Actions') }}</th>
    </tr>
  </thead>
  <tbody>
    {% for n in notifications %}
    <tr>
      <td>{{ n[0] }}</td>
      <td>{{ n[1] }}</td>
      <td>{{ _('Stokvel A') }}</td>
      <td>{{ _('No') }}</td>
      <td>{{ n[2] }}</td>
      <td>{{ n[3] }}</td>
      <td>{{ n[4] }}</td>
      <td class="flex gap-2 justify-center">
        <button class="admin-card btn px-4 py-1 text-sm font-semibold shadow" style="background:linear-gradient(90deg,#60efff 0%,#00ff87 100%);color:#101c2c;" onclick="openViewNotificationModal('{{ n[0] }}', '{{ n[1] }}', '{{ n[2] }}', '{{ n[3] }}', '{{ n[4] }}')">{{ _('View') }}</button>
        <button class="admin-card btn px-4 py-1 text-sm font-semibold shadow" style="background:linear-gradient(90deg,#ff4e50 0%,#f9d423 100%);color:#101c2c;opacity:0.7;" disabled title="Coming soon">{{ _('Delete') }}</button>
      </td>
    </tr>
    {% else %}
    <tr><td colspan="8">{{ _('No notifications found.') }}</td></tr>
    {% endfor %}
  </tbody>
</table>
<!-- Send Notification Modal -->
<div id="sendNotificationModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div class="admin-card p-6 max-w-md w-full relative" style="background:#1b1f27;color:#eaf6fb;">
    <button type="button" onclick="closeSendNotificationModal();" class="absolute top-2 right-2 text-gray-500 hover:text-gray-200 text-2xl">&times;</button>
    <h3 class="text-xl font-bold mb-4" style="color:#60efff;">{{ _('Send Notification') }}</h3>
    <form id="sendNotificationForm" method="POST" action="{{ url_for('admin.send_notification') }}" class="space-y-3">
      {{ csrf_token }}
      <div>
        <label class="block font-semibold mb-1">{{ _('Notification Type') }}</label>
        <select name="notification_type" id="notificationType" class="border border-[#22304a] rounded-lg px-4 py-2 w-full text-black" required onchange="toggleNotificationOptions()">
          <option value="stokvel">{{ _('Send to Stokvel Members') }}</option>
          <option value="all_users">{{ _('Send to All Users') }}</option>
          <option value="specific_user">{{ _('Send to Specific User') }}</option>
        </select>
      </div>
      
      <!-- Stokvel Selection (shown when notification_type is 'stokvel') -->
      <div id="stokvelSection" class="notification-option">
        <label class="block font-semibold mb-1">{{ _('Stokvel') }}</label>
        <select name="stokvel" class="border border-[#22304a] rounded-lg px-4 py-2 w-full text-black">
          <option value="">{{ _('Select a stokvel') }}</option>
          <option>{{ _('Stokvel A') }}</option>
          <option>{{ _('Stokvel B') }}</option>
          <option>{{ _('Stokvel C') }}</option>
        </select>
      </div>
      
      <!-- Specific User Selection (shown when notification_type is 'specific_user') -->
      <div id="specificUserSection" class="notification-option hidden">
        <label class="block font-semibold mb-1">{{ _('User Email') }}</label>
        <input type="email" name="specific_user_email" class="border border-[#22304a] rounded-lg px-4 py-2 w-full text-black" placeholder="{{ _('Enter user email address') }}">
      </div>
      
      <div class="flex items-center gap-2">
        <input type="checkbox" id="urgentCheckbox" name="urgent">
        <label for="urgentCheckbox" class="font-semibold">{{ _('Urgent') }}</label>
      </div>
      <div>
        <label class="block font-semibold mb-1">{{ _('Message') }}</label>
        <textarea name="message" class="border border-[#22304a] rounded-lg px-4 py-2 w-full text-black" rows="3" required placeholder="{{ _('Enter your notification message...') }}"></textarea>
      </div>
      <div>
        <label class="block font-semibold mb-1">{{ _('Type') }}</label>
        <select name="type" class="border border-[#22304a] rounded-lg px-4 py-2 w-full text-black" required>
          <option value="admin_notification">{{ _('Admin Notification') }}</option>
          <option value="General">{{ _('General') }}</option>
          <option value="Alert">{{ _('Alert') }}</option>
          <option value="Update">{{ _('Update') }}</option>
        </select>
      </div>
      <button type="submit" class="admin-card btn w-full mt-4 py-2 text-base font-semibold shadow-md" style="background:linear-gradient(90deg,#60efff 0%,#00ff87 100%);color:#101c2c;">{{ _('Send') }}</button>
    </form>
  </div>
</div>
<!-- View Notification Modal -->
<div id="viewNotificationModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
  <div class="admin-card p-6 max-w-md w-full relative" style="background:#1b1f27;color:#eaf6fb;">
    <button type="button" onclick="closeViewNotificationModal();" class="absolute top-2 right-2 text-gray-500 hover:text-gray-200 text-2xl">&times;</button>
    <h3 class="text-xl font-bold mb-4" style="color:#60efff;">{{ _('Notification Details') }}</h3>
    <ul id="viewNotificationDetails" class="mb-2"></ul>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
function openSendNotificationModal() {
  document.getElementById('sendNotificationModal').classList.remove('hidden');
}
function closeSendNotificationModal() {
  document.getElementById('sendNotificationModal').classList.add('hidden');
}
function openViewNotificationModal(id, userId, message, type, createdAt) {
  var html = '';
  html += `<li><strong>{{ _('ID') }}:</strong> ${id}</li>`;
  html += `<li><strong>{{ _('User ID') }}:</strong> ${userId}</li>`;
  html += `<li><strong>{{ _('Message') }}:</strong> ${message}</li>`;
  html += `<li><strong>{{ _('Type') }}:</strong> ${type}</li>`;
  html += `<li><strong>{{ _('Created At') }}:</strong> ${createdAt}</li>`;
  document.getElementById('viewNotificationDetails').innerHTML = html;
  document.getElementById('viewNotificationModal').classList.remove('hidden');
}
function closeViewNotificationModal() {
  document.getElementById('viewNotificationModal').classList.add('hidden');
}

function toggleNotificationOptions() {
  const notificationType = document.getElementById('notificationType').value;
  const stokvelSection = document.getElementById('stokvelSection');
  const specificUserSection = document.getElementById('specificUserSection');
  
  // Hide all sections first
  stokvelSection.classList.add('hidden');
  specificUserSection.classList.add('hidden');
  
  // Show the appropriate section
  if (notificationType === 'stokvel') {
    stokvelSection.classList.remove('hidden');
  } else if (notificationType === 'specific_user') {
    specificUserSection.classList.remove('hidden');
  }
}
</script>
{% endblock %}