{% extends "base.html" %}
{% block title %}Financial Advisor{% endblock %}

{% block content %}
<div class="p-6 bg-white rounded shadow">
  <h1 class="text-2xl font-semibold mb-4">KasiKash Financial Advisor</h1>
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="col-span-1 lg:col-span-2 space-y-6">
      <!-- Chart placeholders, insights, budgets, goals cards… -->
    </div>
    <div class="space-y-6">
      <div id="chat-container"></div>
      <form id="upload-form" enctype="multipart/form-data">
        <input type="hidden" name="user_id" value="{{ user_id }}">
        <input type="file" name="file" accept=".pdf,.png,.jpg" class="mb-2" />
        <button type="submit" class="btn btn-indigo">Analyze Statement</button>
      </form>
      <div id="upload-results" class="mt-4"></div>
    </div>
  </div>
</div>
<script>
// Chat handling
async function sendChat(msg) {
  const res = await fetch('/financial_advisor/chat', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ user_id: "{{ user_id }}", message: msg })
  });
  const data = await res.json();
  return data.response;
}

function appendMessage(who, text) {
  const box = document.getElementById('messages');
  const el = document.createElement('div');
  el.className = (who === 'You') ? 'text-right text-green-600' : 'text-left text-gray-800';
  el.textContent = who + ': ' + text;
  box.appendChild(el);
  box.scrollTop = box.scrollHeight;
}

function initChat() {
  const container = document.getElementById('chat-container');
  container.innerHTML = `
    <div id="messages" class="h-64 overflow-y-auto border p-4 mb-2"></div>
    <div class="flex">
      <input id="chat-input" class="flex-grow border p-2" placeholder="Ask me anything…" />
      <button id="chat-send" class="btn btn-green ml-2">Send</button>
    </div>`;
  document.getElementById('chat-send').onclick = async function() {
    const input = document.getElementById('chat-input');
    const txt = input.value.trim();
    if (!txt) return;
    appendMessage('You', txt);
    input.value = '';
    const reply = await sendChat(txt);
    appendMessage('Advisor', reply);
  };
}

// Upload handling
window.addEventListener('DOMContentLoaded', function() {
  initChat();
  document.getElementById('upload-form').onsubmit = async function(e) {
    e.preventDefault();
    const form = e.target;
    const data = new FormData(form);
    const res = await fetch(form.action || '/financial_advisor/upload', { method: 'POST', body: data });
    const json = await res.json();
    const container = document.getElementById('upload-results');
    container.innerHTML = '';
    json.alerts.forEach(function(a) {
      const div = document.createElement('div');
      div.className = 'text-red-600';
      div.textContent = a;
      container.appendChild(div);
    });
    // Simple table of txns
    const tbl = document.createElement('table');
    tbl.className = 'min-w-full text-left';
    tbl.innerHTML = '<thead><tr><th>Date</th><th>Description</th><th>Amount</th></tr></thead>';
    const body = document.createElement('tbody');
    json.transactions.forEach(function(t) {
      const row = document.createElement('tr');
      row.innerHTML = '<td>' + t.date + '</td><td>' + t.description + '</td><td>R' + t.amount.toFixed(2) + '</td>';
      body.appendChild(row);
    });
    tbl.appendChild(body);
    container.appendChild(tbl);
  };
});
</script>
{% endblock %} 